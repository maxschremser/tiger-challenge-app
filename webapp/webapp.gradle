buildscript {
    repositories {
        mavenCentral()
        jcenter()
    }
    dependencies {
        classpath "org.cloudfoundry:cf-gradle-plugin:1.1.3"
    }
}

plugins {
    id "java"
    id "groovy"
    id "war"
    id "com.bmuschko.tomcat" version "2.2.5"
    id "com.moowork.node" version "1.1.1"
}

apply plugin: 'cloudfoundry'

repositories {
    mavenCentral()
}

ext {
    tomcatVersion = '9.0.0.M20'
    tomcatVersionJuli = '9.0.0.M6'
    cfSpace='com.schremser'
    cfUsername='schremse@at.ibm.com'
    cfUri='https://cloudanttest28062017.mybluemix.net/'
    cfApplication='cloudanttest28062017'
}

dependencies {
    providedCompile(
            'org.apache.tomcat:tomcat-servlet-api:8.5.0'
    )
    providedCompile group: 'org.apache.cxf', name: 'cxf-rt-frontend-jaxrs', version: tool_cxf_rt_frontend_jaxrs_version

    compile group: 'com.cloudant', name: 'cloudant-client', version: '2.9.0'
    compile group: 'com.fasterxml.jackson.core', name: 'jackson-core', version: tool_jackson_core_version
    compile group: 'com.fasterxml.jackson.core', name: 'jackson-databind', version: tool_jackson_databind_version
    compile group: 'commons-fileupload', name: 'commons-fileupload', version: tool_commons_fileupload_version
    compile group: 'org.apache.poi', name: 'poi', version: tool_apache_poi_version
    compile group: 'org.slf4j', name: 'slf4j-simple', version: tool_slf4j_simple_version

    testCompile group: 'junit', name: 'junit', version: "4.12"
    testCompile localGroovy()

    tomcat "org.apache.tomcat.embed:tomcat-embed-core:${tomcatVersion}"
    tomcat "org.apache.tomcat.embed:tomcat-embed-logging-juli:${tomcatVersionJuli}"
    tomcat "org.apache.tomcat.embed:tomcat-embed-jasper:${tomcatVersion}"
}

war {
    dependsOn 'ng_build'
    baseName 'tiger-challenge-app'

    //for development mode you can override jsBuildDir (jsBuildDir = /ngdev) in your local gradle properties file (~/.gradle/gradle.properties)
    //to configure your IDE to use development javascript in your build
    from "${project.projectDir}/${project.jsBuildDir}"
    include '**/*'
}

cloudfoundry {
    target='https://api.ng.bluemix.net'
    space=cfSpace
    username=cfUsername
    password=file('.password').text
    file=war.archivePath
    uri=cfUri
    application=cfApplication
}

// deploy related tasks
//
task ng_build_ios(type: Exec, dependsOn: npmInstall) {
    workingDir 'ngdev'
    commandLine 'ionic', 'cordova', 'build', 'ios'
}

task ng_build_android(type: Exec, dependsOn: npmInstall) {
    workingDir 'ngdev'
    commandLine 'ionic', 'cordova', 'build', 'android'
}

task ng_build(dependsOn: [npmInstall, ng_build_ios, ng_build_android]) {
}

task ng_serve(type: Exec, dependsOn: npmInstall) {
    workingDir 'ngdev'
    commandLine 'ionic', 'serve'
}

task deployApp(type: Copy) {
    from 'ngdev/dist'
    into depxpnsr + '/ngdev'
}

task deploy_init(dependsOn: [build, nodeSetup, npmInstall]) {
    doLast {
        println 'Deploying to ' + deploydir
    }
}

task deploy(type: Copy, dependsOn: [deploy_init, ng_build, deployApp]) {
    println "Generated war file is ${war.archivePath}"
    from zipTree(war.archivePath)
    into file("$buildDir/libs/exploded")
    doLast {
        println "war is exploded into $buildDir/libs/exploded"
    }
}

task stageBluemix(dependsOn: [deploy]) {
    doLast {
        println "Pushing App to Bluemix"
        cfLogin.execute()
        cfPush.execute()
    }
}